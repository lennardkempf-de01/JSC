<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSC-Ausflugs-Planer</title>
  <style>
    :root{
      --w95-face:#c0c0c0;
      --w95-shadow:#808080;
      --w95-dark:#000;
      --w95-light:#fff;
      --w95-title:#000080;
      --w95-title-text:#fff;
      --w95-bg:#008080;
      --w95-inset1:#808080;
      --w95-inset2:#ffffff;
      --w95-link:#0000ee;
      --font: Tahoma, "MS Sans Serif", Arial, sans-serif;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--w95-bg);
      color:#000;
    }

    /* Win95 primitives */
    .w95-window{
      background:var(--w95-face);
      border:2px solid var(--w95-light);
      border-right-color:var(--w95-shadow);
      border-bottom-color:var(--w95-shadow);
      box-shadow:1px 1px 0 0 var(--w95-dark);
    }
    .w95-inset{
      border:2px solid var(--w95-shadow);
      border-right-color:var(--w95-light);
      border-bottom-color:var(--w95-light);
      background:#fff;
    }
    .titlebar{
      display:flex;
      align-items:center;
      gap:8px;
      height:26px;
      padding:0 8px;
      background:var(--w95-title);
      color:var(--w95-title-text);
      user-select:none;
      font-weight:700;
      font-size:13px;
    }
    .titlebar .icon{
      width:14px;height:14px;
      border:1px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.25);
      display:inline-block;
    }

    .menubar{
      display:flex;
      gap:2px;
      padding:3px 6px;
      background:var(--w95-face);
      border-bottom:1px solid var(--w95-shadow);
      position:relative;
      user-select:none;
    }
    .menuitem{
      padding:2px 10px;
      border:1px solid transparent;
      cursor:default;
    }
    .menuitem:focus{outline:none;}
    .menuitem.active{
      border:1px solid var(--w95-shadow);
      border-right-color:var(--w95-light);
      border-bottom-color:var(--w95-light);
      background:#dcdcdc;
    }
    .dropdown{
      position:absolute;
      top:26px;
      left:0;
      min-width:180px;
      background:var(--w95-face);
      border:2px solid var(--w95-light);
      border-right-color:var(--w95-shadow);
      border-bottom-color:var(--w95-shadow);
      box-shadow:1px 1px 0 0 var(--w95-dark);
      padding:4px;
      display:none;
      z-index:50;
    }
    .dropdown.open{display:block;}
    .dd-item{
      padding:4px 8px;
      cursor:default;
      border:1px solid transparent;
      font-size:13px;
    }
    .dd-item:hover{border:1px dotted #000; background:#e9e9e9;}
    .dd-sep{height:1px;background:var(--w95-shadow);margin:4px 2px;}

    .btn{
      font-family:var(--font);
      font-size:13px;
      padding:4px 10px;
      background:var(--w95-face);
      border:2px solid var(--w95-light);
      border-right-color:var(--w95-shadow);
      border-bottom-color:var(--w95-shadow);
      box-shadow:1px 1px 0 0 var(--w95-dark);
      cursor:pointer;
    }
    .btn:active{
      border:2px solid var(--w95-shadow);
      border-right-color:var(--w95-light);
      border-bottom-color:var(--w95-light);
      box-shadow:none;
      transform:translate(1px,1px);
    }

    input, textarea, select{
      font-family:var(--font);
      font-size:13px;
    }
    .field{width:100%; padding:4px 6px;}

    /* Layout */
    .center{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* LOGIN */
    #loginScreen{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background:var(--w95-bg);
      z-index:9999;
      padding:16px;
    }
    #loginWindow{
      width:min(520px, calc(100vw - 24px));
    }
    .login-body{
      padding:12px;
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:8px 10px;
      align-items:center;
    }
    .login-body .hint{grid-column:1 / -1; font-size:12px; color:#222;}
    .login-actions{grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end; margin-top:6px;}
    .login-error{grid-column:1 / -1; color:#a00000; font-weight:700; display:none;}

    /* APP */
    #appShell{display:none; padding:18px;}
    #mainWindow{
      width:min(1120px, calc(100vw - 36px));
      margin:0 auto;
    }
    .client{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:10px;
      padding:10px;
    }
    .sidebar{
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .group-title{
      font-weight:700;
      font-size:12px;
      margin:0 0 6px 2px;
    }
    .navlist{display:flex; flex-direction:column; gap:6px;}
    .navbtn{
      width:100%;
      text-align:left;
      padding:7px 8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .navbtn{width:100%; text-align:left; padding:7px 8px; display:flex; align-items:center; gap:10px;}
.navbtn .ico{width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; flex:0 0 auto;}
.navtxt{min-width:0;}
.navttl{font-weight:700;}
.navsub{font-size:11px; opacity:.8; margin-top:1px;}
.navbtn.active{background:#dcdcdc; border:2px solid var(--w95-shadow); border-right-color:var(--w95-light); border-bottom-color:var(--w95-light); box-shadow:none; transform:none;}

    .content{
      padding:8px;
    }
    .pane{display:none;}
    .pane.active{display:block;}

    .card{
      padding:10px;
      margin-bottom:10px;
    }
    .card h3{margin:0 0 8px 0; font-size:14px;}

    .grid2{display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap:10px;}
    .grid3{display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr) minmax(0,1fr); gap:10px;}

    label{font-size:12px; font-weight:700; display:block; margin-bottom:4px;}
    .row{display:flex; gap:8px; align-items:center;}
    .row > *{flex:1;}

    table{width:100%; border-collapse:collapse; table-layout:fixed;}
    th,td{border:1px solid #000; padding:4px; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    th{background:#e6e6e6;}
    .tablewrap{overflow:auto; max-width:100%;}
    .tablewrap input{width:100%;}

    .statusbar{
      border-top:1px solid var(--w95-shadow);
      padding:4px 8px;
      font-size:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    a{color:var(--w95-link);}

    /* Invitation preview */
    #invitePreview{
      background:#fff;
      color:#000;
      padding:18px;
      max-width:820px;
      margin:0 auto;
      border:1px solid #bbb;
    }
    .invite-header{display:flex; justify-content:center; margin-bottom:10px;}
    .invite-header img{max-width:520px; width:100%; height:auto;}
    .invite-title{font-size:20px; font-weight:800; text-align:center; margin:6px 0 14px 0;}
    .invite-kv{width:100%; border-collapse:collapse; margin:10px 0 12px 0;}
    .invite-kv td{border:none; padding:2px 0; font-size:13px; vertical-align:top;}
    .invite-kv td.k{width:140px; font-weight:800;}
    .invite-section-title{font-weight:800; margin:10px 0 4px 0;}
    .invite-footer{display:grid; grid-template-columns: 1fr 220px; gap:12px; align-items:end; margin-top:14px;}
    .qrbox{border:1px solid #000; padding:6px; width:220px; justify-self:end;}
    .qrbox img{width:100%; height:auto; display:block;}
    .tiny{font-size:10.5px; color:#111; line-height:1.25;}

    /* Print */
    @media print{
      body{background:#fff;}
      #appShell, #loginScreen{display:none !important;}
    }

    /* Small screens */
    @media (max-width: 920px){
      .client{grid-template-columns:1fr;}
      .sidebar{order:2;}
      .content{order:1;}
    }

  </style>
</head>
<body>

  <!-- LOGIN (shows BEFORE program) -->
  <div id="loginScreen">
    <div id="loginWindow" class="w95-window">
      <div class="titlebar"><span class="icon"></span> Anmeldung – JSC-Ausflugs-Planer</div>
      <div class="login-body">
        <div class="hint">Bitte anmelden, um den Planer zu verwenden.</div>
        <div class="login-error" id="loginError">Falsches Passwort.</div>

        <label for="loginName">Name</label>
        <input id="loginName" class="w95-inset field" autocomplete="username" />

        <label for="loginPass">Passwort</label>
        <input id="loginPass" class="w95-inset field" type="password" autocomplete="current-password" />

        <div class="hint">Hinweis: Beim Schließen des Browsers wird die Anmeldung wieder abgefragt.</div>
        <div class="login-actions">
          <button class="btn" id="loginOk">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appShell">
    <div id="mainWindow" class="w95-window">
      <div class="titlebar"><span class="icon"></span> JSC-Ausflugs-Planer</div>

      <div class="menubar" id="menubar">
        <div class="menuitem" tabindex="0" data-menu="file">Datei</div>
        <div class="menuitem" tabindex="0" data-menu="edit">Bearbeiten</div>
        <div class="menuitem" tabindex="0" data-menu="view">Ansicht</div>
        <div class="menuitem" tabindex="0" data-menu="help">Hilfe</div>

        <div class="dropdown" id="dd-file">
          <div class="dd-item" data-action="printInvitation">Einladung drucken / als PDF speichern…</div>
          <div class="dd-item" data-action="saveHtml">Einladung als HTML speichern…</div>
          <div class="dd-sep"></div>
          <div class="dd-item" data-action="exportJson">Plan als JSON exportieren…</div>
          <div class="dd-item" data-action="importJson">JSON importieren…</div>
        </div>

        <div class="dropdown" id="dd-edit">
          <div class="dd-item" data-action="loadExample">Beispieldaten laden</div>
          <div class="dd-item" data-action="resetAll">Neuer Plan (Reset)</div>
        </div>

        <div class="dropdown" id="dd-view">
          <div class="dd-item" data-action="toggleCompact">Kompaktmodus umschalten</div>
        </div>

        <div class="dropdown" id="dd-help">
          <div class="dd-item" data-action="about">Kurzanleitung</div>
        </div>
      </div>

      <div class="client">
        <!-- Sidebar / Navigator -->
        <div class="sidebar w95-window" style="padding:10px;">
          <div>
            <div class="group-title">Planungsschritte</div>
            <div class="navlist">
              <button class="btn navbtn active" data-pane="event"><span class="ico"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><rect x="2" y="3" width="12" height="11" fill="none" stroke="#000"/><rect x="2" y="5" width="12" height="2" fill="#000"/><rect x="4" y="1" width="2" height="4" fill="#000"/><rect x="10" y="1" width="2" height="4" fill="#000"/></svg></span><div class="navtxt"><div class="navttl">Event</div><div class="navsub">Zeitraum · Ort · Kosten</div></div></button>
              <button class="btn navbtn" data-pane="people"><span class="ico"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><circle cx="6" cy="6" r="2" fill="none" stroke="#000"/><circle cx="11" cy="6" r="2" fill="none" stroke="#000"/><path d="M2 14c0-2 2-3 4-3s4 1 4 3" fill="none" stroke="#000"/><path d="M7 14c.3-1.8 1.9-3 4-3 1.8 0 3.4.8 3.9 3" fill="none" stroke="#000"/></svg></span><div class="navtxt"><div class="navttl">Teilnehmer</div><div class="navsub">Kinder & Betreuer</div></div></button>
              <button class="btn navbtn" data-pane="cars"><span class="ico"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M3 10l1-4h8l1 4" fill="none" stroke="#000"/><rect x="2" y="9" width="12" height="3" fill="none" stroke="#000"/><circle cx="5" cy="12" r="1" fill="#000"/><circle cx="11" cy="12" r="1" fill="#000"/></svg></span><div class="navtxt"><div class="navttl">Autos</div><div class="navsub">Fahrer & Plätze</div></div></button>
              <button class="btn navbtn" data-pane="invite"><span class="ico"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><rect x="3" y="2" width="10" height="12" fill="none" stroke="#000"/><path d="M5 5h6M5 7h6M5 9h6" stroke="#000"/></svg></span><div class="navtxt"><div class="navttl">Einladung</div><div class="navsub">QR · PDF · ICS</div></div></button>
              <button class="btn navbtn" data-pane="check"><span class="ico"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><rect x="2" y="2" width="12" height="12" fill="none" stroke="#000"/><path d="M4 8l2 2 6-6" fill="none" stroke="#000" stroke-width="2"/></svg></span><div class="navtxt"><div class="navttl">Checkliste</div><div class="navsub">Aufgaben & Haken</div></div></button>
            </div>
          </div>
          <div>
            <div class="group-title">Extras</div>
            <div class="navlist">
              <button class="btn navbtn" data-pane="dash"><span class="ico"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><rect x="2" y="9" width="2" height="5" fill="#000"/><rect x="6" y="6" width="2" height="8" fill="#000"/><rect x="10" y="3" width="2" height="11" fill="#000"/><path d="M1 14h14" stroke="#000"/></svg></span><div class="navtxt"><div class="navttl">Dashboard</div><div class="navsub">Überblick</div></div></button>
              <button class="btn navbtn" data-pane="io"><span class="ico"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M3 5h7" stroke="#000"/><path d="M8 3l2 2-2 2" fill="none" stroke="#000"/><path d="M13 11H6" stroke="#000"/><path d="M8 9l-2 2 2 2" fill="none" stroke="#000"/></svg></span><div class="navtxt"><div class="navttl">Import / Export</div><div class="navsub">JSON sichern / laden</div></div></button>
            </div>
          </div>
        </div>

        <!-- Content -->
        <div class="content">

          <!-- Event pane -->
          <section class="pane active" id="pane-event">
            <div class="w95-window card">
              <h3>Eventdaten</h3>
              <div class="grid2">
                <div>
                  <label for="evTitle">Titel</label>
                  <input id="evTitle" class="w95-inset field" placeholder="z.B. Kletterpark-Ausflug" />
                </div>
                <div>
                  <label for="evTarget">Für wen? (Zielgruppe)</label>
                  <input id="evTarget" class="w95-inset field" placeholder="z.B. alle ab 8 Jahren" />
                </div>

                <div class="w95-window" style="padding:8px;">
                  <div style="font-weight:700; font-size:12px; margin-bottom:6px;">Zeitraum</div>
                  <div class="grid2">
                    <div>
                      <label for="evStartDate">Startdatum</label>
                      <input id="evStartDate" type="date" class="w95-inset field" />
                    </div>
                    <div>
                      <label for="evStartTime">Start</label>
                      <input id="evStartTime" type="time" class="w95-inset field" />
                    </div>
                    <div>
                      <label for="evEndDate">Enddatum</label>
                      <input id="evEndDate" type="date" class="w95-inset field" />
                      <div style="font-size:11px; margin-top:3px;">(leer = gleicher Tag)</div>
                    </div>
                    <div>
                      <label for="evEndTime">Ende</label>
                      <input id="evEndTime" type="time" class="w95-inset field" />
                    </div>
                  </div>
                </div>

                <div>
                  <label for="evPlace">Ort / Adresse</label>
                  <input id="evPlace" class="w95-inset field" placeholder="Adresse, Stadt" />
                  <div style="height:8px"></div>
                  <label for="evMeet">Treffpunkt / Abfahrt</label>
                  <input id="evMeet" class="w95-inset field" placeholder="z.B. Vereinsheim Parkplatz" />
                </div>

                <div>
                  <div class="grid2">
                    <div>
                      <label for="evCost">Kosten pro Kind (€)</label>
                      <input id="evCost" class="w95-inset field" type="number" min="0" step="0.5" />
                    </div>
                    <div>
                      <label for="evDeadline">Anmeldeschluss</label>
                      <input id="evDeadline" class="w95-inset field" type="date" />
                    </div>
                  </div>
                  <div style="height:8px"></div>
                  <label for="evContact">Kontakt (Name + Tel / Mail)</label>
                  <input id="evContact" class="w95-inset field" placeholder="z.B. Lennard – 0151… / jugendvorstand@…" />
                  <div style="height:8px"></div>
                  <label for="evForms">Anmeldelink (Forms)</label>
                  <input id="evForms" class="w95-inset field" placeholder="z.B. https://forms.gle/..." />
                </div>
              </div>
            </div>

            <div class="grid2">
              <div class="w95-window card">
                <h3>Mitbringen (Liste)</h3>
                <textarea id="evBring" class="w95-inset field" rows="9" placeholder="• Trinkflasche\n• Sportkleidung\n• Wetterfeste Kleidung"></textarea>
              </div>
              <div>
                <div class="w95-window card">
                  <h3>Programm / Ablauf (optional)</h3>
                  <textarea id="evProgram" class="w95-inset field" rows="5" placeholder="Kurzer Ablauf / was machen wir?"></textarea>
                </div>
                <div class="w95-window card">
                  <h3>Hinweise</h3>
                  <textarea id="evNotes" class="w95-inset field" rows="4" placeholder="Notfallnummer, Allergien melden, ..."></textarea>
                </div>
              </div>
            </div>
          </section>

          <!-- People -->
          <section class="pane" id="pane-people">
            <div class="w95-window card">
              <h3>Teilnehmer – Kinder</h3>
              <div class="row" style="justify-content:flex-end; margin-bottom:8px;">
                <button class="btn" id="addChild">+ Kind hinzufügen</button>
              </div>
              <div class="tablewrap w95-inset">
                <table>
                  <thead>
                    <tr>
                      <th style="width:55%">Name</th>
                      <th style="width:20%">Alter</th>
                      <th style="width:25%">Entfernen</th>
                    </tr>
                  </thead>
                  <tbody id="childrenTbody"></tbody>
                </table>
              </div>
            </div>

            <div class="w95-window card">
              <h3>Teilnehmer – Betreuer</h3>
              <div class="row" style="justify-content:flex-end; margin-bottom:8px;">
                <button class="btn" id="addCarer">+ Betreuer hinzufügen</button>
              </div>
              <div class="tablewrap w95-inset">
                <table>
                  <thead>
                    <tr>
                      <th style="width:40%">Name</th>
                      <th style="width:30%">Telefon</th>
                      <th style="width:15%">Fährt?</th>
                      <th style="width:15%">Entfernen</th>
                    </tr>
                  </thead>
                  <tbody id="carersTbody"></tbody>
                </table>
              </div>
              <div style="font-size:12px; margin-top:8px;">Hinweis: "Fährt?" markiert, wer grundsätzlich als Fahrer in Frage kommt. Plätze werden im Schritt „Autos“ verwaltet.</div>
            </div>
          </section>

          <!-- Cars -->
          <section class="pane" id="pane-cars">
            <div class="w95-window card">
              <h3>Autos – Fahrer & Plätze</h3>
              <div class="row" style="justify-content:flex-end; margin-bottom:8px;">
                <button class="btn" id="addCar">+ Auto hinzufügen</button>
                <button class="btn" id="autoAssign">Auto-Aufteilung</button>
              </div>
              <div class="tablewrap w95-inset">
                <table>
                  <thead>
                    <tr>
                      <th style="width:45%">Fahrer</th>
                      <th style="width:25%">Auto / Kennung</th>
                      <th style="width:15%">Sitzplätze</th>
                      <th style="width:15%">Entfernen</th>
                    </tr>
                  </thead>
                  <tbody id="carsTbody"></tbody>
                </table>
              </div>
              <div id="assignResult" style="margin-top:10px; font-size:13px;"></div>
            </div>
          </section>

          <!-- Invitation -->
          <section class="pane" id="pane-invite">
            <div class="w95-window card">
              <h3>Einladung / PDF</h3>
              <div class="row" style="justify-content:flex-end; margin-bottom:8px;">
                <button class="btn" id="refreshInvite">Vorschau aktualisieren</button>
                <button class="btn" id="printInvite">Drucken / als PDF</button>
                <button class="btn" id="downloadIcs">Kalenderdatei (ICS)</button>
              </div>
              <div style="font-size:12px; margin-bottom:10px;">
                Tipp: Wenn du einen Forms-Link einträgst, wird automatisch ein QR-Code erzeugt.
              </div>
              <div id="inviteHost"></div>
            </div>
          </section>

          <!-- Checklist -->
          <section class="pane" id="pane-check">
            <div class="w95-window card">
              <h3>Checkliste</h3>
              <div class="row" style="justify-content:flex-end; margin-bottom:8px;">
                <button class="btn" id="addTask">+ Aufgabe hinzufügen</button>
              </div>
              <div class="tablewrap w95-inset">
                <table>
                  <thead>
                    <tr>
                      <th style="width:70%">Aufgabe</th>
                      <th style="width:15%">Erledigt</th>
                      <th style="width:15%">Entfernen</th>
                    </tr>
                  </thead>
                  <tbody id="tasksTbody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Dashboard -->
          <section class="pane" id="pane-dash">
            <div class="w95-window card">
              <h3>Dashboard</h3>
              <div id="dashSummary" class="w95-inset" style="padding:10px;"></div>
            </div>
          </section>

          <!-- Import/Export -->
          <section class="pane" id="pane-io">
            <div class="w95-window card">
              <h3>Import / Export</h3>
              <div class="row" style="justify-content:flex-start; margin-bottom:8px; flex-wrap:wrap;">
                <button class="btn" id="exportJsonBtn">JSON exportieren</button>
                <button class="btn" id="importJsonBtn">JSON importieren</button>
                <button class="btn" id="saveBtn">Speichern</button>
                <button class="btn" id="resetBtn">Reset</button>
              </div>
              <div class="w95-inset" style="padding:10px; font-size:13px;">
                <div><b>Hinweis:</b> JSON ist ideal, um Pläne zu sichern oder zu teilen. Import überschreibt den aktuellen Plan.</div>
                <div style="margin-top:8px;">Einfach: Export klicken → Datei speichern → später Import klicken.</div>
              </div>
              <input id="fileInput" type="file" accept="application/json" style="display:none" />
            </div>
          </section>

        </div>
      </div>

      <div class="statusbar">
        <div id="statusLeft">Bereit</div>
        <div id="statusRight">JSC-Ausflugs-Planer</div>
      </div>
    </div>
  </div>

  <script>
    // -------------------- Helpers --------------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const STORAGE_KEY = 'jsc_ausflugs_planer_v2';
    const LOGIN_KEY = 'jsc_ausflugs_planer_loggedin';
    const PASSWORD = 'judotanzaikido';

    function fmtDate(d){
      if(!d) return '';
      const dt = new Date(d);
      const dd = String(dt.getDate()).padStart(2,'0');
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const yy = dt.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    function fmtDateLong(d){
      if(!d) return '';
      const dt = new Date(d);
      const days = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
      const dd = String(dt.getDate()).padStart(2,'0');
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const yy = dt.getFullYear();
      return `${days[dt.getDay()]}, ${dd}.${mm}.${yy}`;
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function toLocalISO(dateStr, timeStr){
      // dateStr: YYYY-MM-DD, timeStr: HH:MM
      if(!dateStr) return null;
      const t = timeStr || '00:00';
      return new Date(`${dateStr}T${t}:00`);
    }

    function clamp(n, min, max){return Math.max(min, Math.min(max, n));}

    // -------------------- Data Model --------------------
    const defaultPlan = () => ({
      event: {
        title: '',
        startDate: '',
        startTime: '',
        endDate: '',
        endTime: '',
        place: '',
        meeting: '',
        target: '',
        cost: 0,
        deadline: '',
        contact: '',
        forms: '',
        bring: '• Trinkflasche\n• Sportkleidung\n• Wetterfeste Kleidung',
        program: '',
        notes: 'Bitte Allergien/Unverträglichkeiten vorher mitteilen.',
      },
      people: {
        children: [],
        carers: [],
      },
      cars: [],
      tasks: [
        {text:'Einladung verschicken', done:false},
        {text:'Notfallnummern-Liste', done:false},
        {text:'Fahrgemeinschaften final', done:false}
      ]
    });

    let plan = defaultPlan();

    // -------------------- Login --------------------
    function showApp(){
      $('#loginScreen').style.display = 'none';
      $('#appShell').style.display = 'block';
      setStatus('Bereit');
      renderAll();
      refreshInvitation();
      refreshDashboard();
    }

    function requireLogin(){
      const ok = sessionStorage.getItem(LOGIN_KEY) === '1';
      if(ok){
        showApp();
        return;
      }
      // ensure app not visible behind
      $('#appShell').style.display = 'none';
      $('#loginScreen').style.display = 'grid';
      $('#loginName').focus();
    }

    function doLogin(){
      const pass = ($('#loginPass').value || '').trim();
      if(pass === PASSWORD){
        sessionStorage.setItem(LOGIN_KEY,'1');
        $('#loginError').style.display='none';
        showApp();
      }else{
        $('#loginError').style.display='block';
        $('#loginPass').focus();
        $('#loginPass').select();
      }
    }

    $('#loginOk').addEventListener('click', doLogin);
    $('#loginPass').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });
    $('#loginName').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('#loginPass').focus(); });

    // -------------------- Menu --------------------
    const menuMap = {
      file: $('#dd-file'),
      edit: $('#dd-edit'),
      view: $('#dd-view'),
      help: $('#dd-help'),
    };

    function closeMenus(){
      $$('.menuitem').forEach(m=>m.classList.remove('active'));
      Object.values(menuMap).forEach(dd=>dd.classList.remove('open'));
    }

    function openMenu(which, anchor){
      closeMenus();
      const dd = menuMap[which];
      if(!dd) return;
      const r = anchor.getBoundingClientRect();
      const parentR = $('#menubar').getBoundingClientRect();
      dd.style.left = `${r.left - parentR.left}px`;
      dd.classList.add('open');
      anchor.classList.add('active');
    }

    $$('.menuitem').forEach(mi=>{
      mi.addEventListener('mousedown', (e)=>{
        e.preventDefault();
        const which = mi.dataset.menu;
        const dd = menuMap[which];
        const open = dd.classList.contains('open');
        if(open) closeMenus(); else openMenu(which, mi);
      });
    });

    document.addEventListener('mousedown', (e)=>{
      if(!e.target.closest('.menubar')) closeMenus();
    });

    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape') closeMenus();
    });

    $$('.dropdown .dd-item').forEach(item=>{
      item.addEventListener('click', ()=>{
        const action = item.dataset.action;
        closeMenus();
        handleAction(action);
      });
    });

    function handleAction(action){
      switch(action){
        case 'printInvitation':
          printInvitation();
          break;
        case 'saveHtml':
          downloadInvitationHtml();
          break;
        case 'exportJson':
          exportJson();
          break;
        case 'importJson':
          $('#fileInput').click();
          break;
        case 'loadExample':
          loadExample();
          break;
        case 'resetAll':
          if(confirm('Wirklich alles zurücksetzen?')){ plan = defaultPlan(); save(); renderAll(); refreshInvitation(); refreshDashboard(); }
          break;
        case 'toggleCompact':
          document.body.classList.toggle('compact');
          break;
        case 'about':
          alert('JSC-Ausflugs-Planer\n\nAblauf: Eventdaten → Teilnehmer → Autos → Einladung/PDF → Checkliste.\n\nTipp: Forms-Link eintragen → QR-Code wird automatisch erzeugt.');
          break;
      }
    }

    // -------------------- Navigation panes --------------------
    function setPane(name){
      $$('.navbtn').forEach(b=>b.classList.toggle('active', b.dataset.pane===name));
      $$('.pane').forEach(p=>p.classList.toggle('active', p.id===`pane-${name}`));
      if(name==='invite') refreshInvitation();
      if(name==='dash') refreshDashboard();
    }

    $$('.navbtn').forEach(b=>b.addEventListener('click', ()=>setPane(b.dataset.pane)));

    // -------------------- Bind fields --------------------
    const bindings = [
      ['evTitle','event.title'],
      ['evStartDate','event.startDate'],
      ['evStartTime','event.startTime'],
      ['evEndDate','event.endDate'],
      ['evEndTime','event.endTime'],
      ['evPlace','event.place'],
      ['evMeet','event.meeting'],
      ['evTarget','event.target'],
      ['evCost','event.cost'],
      ['evDeadline','event.deadline'],
      ['evContact','event.contact'],
      ['evForms','event.forms'],
      ['evBring','event.bring'],
      ['evProgram','event.program'],
      ['evNotes','event.notes'],
    ];

    function setByPath(obj, path, value){
      const parts = path.split('.');
      let cur = obj;
      for(let i=0;i<parts.length-1;i++) cur = cur[parts[i]];
      cur[parts[parts.length-1]] = value;
    }
    function getByPath(obj, path){
      const parts = path.split('.');
      let cur = obj;
      for(const p of parts) cur = cur[p];
      return cur;
    }

    function wireBindings(){
      for(const [id, path] of bindings){
        const el = $('#'+id);
        if(!el) continue;
        el.addEventListener('input', ()=>{
          let v = el.value;
          if(id==='evCost') v = Number(v||0);
          setByPath(plan, path, v);
          save();
          if(id==='evForms') refreshInvitation();
          refreshDashboard();
        });
      }
    }

    // -------------------- People tables --------------------
    function renderChildren(){
      const tb = $('#childrenTbody');
      tb.innerHTML = '';
      plan.people.children.forEach((c, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="w95-inset" value="${escapeHtml(c.name||'')}" data-k="name" data-i="${idx}" data-t="child"></td>
          <td><input class="w95-inset" value="${escapeHtml(c.age||'')}" data-k="age" data-i="${idx}" data-t="child"></td>
          <td><button class="btn" data-del="child" data-i="${idx}">Entfernen</button></td>
        `;
        tb.appendChild(tr);
      });
    }

    function renderCarers(){
      const tb = $('#carersTbody');
      tb.innerHTML='';
      plan.people.carers.forEach((c, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="w95-inset" value="${escapeHtml(c.name||'')}" data-k="name" data-i="${idx}" data-t="carer"></td>
          <td><input class="w95-inset" value="${escapeHtml(c.phone||'')}" data-k="phone" data-i="${idx}" data-t="carer"></td>
          <td style="text-align:center"><input type="checkbox" ${c.driver? 'checked':''} data-k="driver" data-i="${idx}" data-t="carer"></td>
          <td><button class="btn" data-del="carer" data-i="${idx}">Entfernen</button></td>
        `;
        tb.appendChild(tr);
      });
    }

    function bindPeopleEvents(){
      $('#childrenTbody').addEventListener('input', (e)=>{
        const el = e.target;
        if(!(el instanceof HTMLInputElement)) return;
        const t = el.dataset.t;
        if(t!=='child') return;
        const i = Number(el.dataset.i);
        const k = el.dataset.k;
        plan.people.children[i][k] = el.value;
        save();
        refreshDashboard();
      });

      $('#carersTbody').addEventListener('input', (e)=>{
        const el = e.target;
        if(!(el instanceof HTMLInputElement)) return;
        const t = el.dataset.t;
        if(t!=='carer') return;
        const i = Number(el.dataset.i);
        const k = el.dataset.k;
        if(k==='driver') plan.people.carers[i][k] = el.checked;
        else plan.people.carers[i][k] = el.value;
        save();
        refreshDashboard();
      });

      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-del]');
        if(!btn) return;
        const type = btn.dataset.del;
        const i = Number(btn.dataset.i);
        if(type==='child') plan.people.children.splice(i,1);
        if(type==='carer') plan.people.carers.splice(i,1);
        save();
        renderChildren();
        renderCarers();
        refreshDashboard();
      });

      $('#addChild').addEventListener('click', ()=>{
        plan.people.children.push({name:'', age:''});
        save();
        renderChildren();
        refreshDashboard();
      });

      $('#addCarer').addEventListener('click', ()=>{
        plan.people.carers.push({name:'', phone:'', driver:false});
        save();
        renderCarers();
        refreshDashboard();
      });
    }

    // -------------------- Cars --------------------
    function renderCars(){
      const tb = $('#carsTbody');
      tb.innerHTML='';
      plan.cars.forEach((c, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="w95-inset" value="${escapeHtml(c.driver||'')}" data-k="driver" data-i="${idx}" data-t="car"></td>
          <td><input class="w95-inset" value="${escapeHtml(c.label||'')}" data-k="label" data-i="${idx}" data-t="car" placeholder="z.B. Kombi"></td>
          <td><input class="w95-inset" value="${escapeHtml(String(c.seats??4))}" data-k="seats" data-i="${idx}" data-t="car" type="number" min="1" max="9"></td>
          <td><button class="btn" data-del="car" data-i="${idx}">Entfernen</button></td>
        `;
        tb.appendChild(tr);
      });
    }

    function bindCarEvents(){
      $('#carsTbody').addEventListener('input', (e)=>{
        const el = e.target;
        if(!(el instanceof HTMLInputElement)) return;
        if(el.dataset.t!=='car') return;
        const i = Number(el.dataset.i);
        const k = el.dataset.k;
        let v = el.value;
        if(k==='seats') v = clamp(Number(v||4),1,99);
        plan.cars[i][k] = v;
        save();
        refreshDashboard();
      });

      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-del="car"]');
        if(!btn) return;
        const i = Number(btn.dataset.i);
        plan.cars.splice(i,1);
        save();
        renderCars();
        refreshDashboard();
      });

      $('#addCar').addEventListener('click', ()=>{
        const suggested = plan.people.carers.find(c=>c.driver && c.name)?.name || '';
        plan.cars.push({driver:suggested, label:'', seats:5});
        save();
        renderCars();
        refreshDashboard();
      });

      $('#autoAssign').addEventListener('click', ()=>{
        const people = [...plan.people.children.map(c=>c.name).filter(Boolean), ...plan.people.carers.map(c=>c.name).filter(Boolean)];
        const cars = plan.cars.map(c=>({driver:c.driver||'Fahrer', seats:Number(c.seats||0)})).filter(c=>c.seats>0);
        if(cars.length===0){ $('#assignResult').innerHTML = '<b>Bitte zuerst Autos mit Sitzplätzen anlegen.</b>'; return; }

        // Simple greedy assignment (excluding drivers count as already in car)
        const assignments = cars.map(c=>({car:c, list:[c.driver].filter(Boolean), cap:Math.max(0, c.seats - (c.driver?1:0))}));
        const rest = people.filter(n=>!assignments.some(a=>a.list[0]===n));
        let ci=0;
        for(const p of rest){
          while(ci<assignments.length && assignments[ci].cap<=0) ci++;
          if(ci>=assignments.length) break;
          assignments[ci].list.push(p);
          assignments[ci].cap--;
        }
        const unassigned = rest.slice(assignments.reduce((acc,a)=>acc+(a.list.length-(a.list[0]?1:0)),0));

        let html = '<div style="font-weight:700; margin-bottom:6px;">Auto-Aufteilung</div>';
        html += assignments.map(a=>`<div style="margin:4px 0;"><b>${escapeHtml(a.car.driver||'Auto')}</b>: ${a.list.map(escapeHtml).join(', ')}</div>`).join('');
        if(unassigned.length) html += `<div style="margin-top:8px; color:#a00000;"><b>Kein Platz für:</b> ${unassigned.map(escapeHtml).join(', ')}</div>`;
        $('#assignResult').innerHTML = html;
      });
    }

    // -------------------- Tasks --------------------
    function renderTasks(){
      const tb = $('#tasksTbody');
      tb.innerHTML='';
      plan.tasks.forEach((t, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="w95-inset" value="${escapeHtml(t.text||'')}" data-k="text" data-i="${idx}" data-t="task"></td>
          <td style="text-align:center"><input type="checkbox" ${t.done?'checked':''} data-k="done" data-i="${idx}" data-t="task"></td>
          <td><button class="btn" data-del="task" data-i="${idx}">Entfernen</button></td>
        `;
        tb.appendChild(tr);
      });
    }

    function bindTaskEvents(){
      $('#tasksTbody').addEventListener('input', (e)=>{
        const el = e.target;
        if(!(el instanceof HTMLInputElement)) return;
        if(el.dataset.t!=='task') return;
        const i = Number(el.dataset.i);
        const k = el.dataset.k;
        plan.tasks[i][k] = (k==='done') ? el.checked : el.value;
        save();
        refreshDashboard();
      });

      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-del="task"]');
        if(!btn) return;
        const i = Number(btn.dataset.i);
        plan.tasks.splice(i,1);
        save();
        renderTasks();
        refreshDashboard();
      });

      $('#addTask').addEventListener('click', ()=>{
        plan.tasks.push({text:'', done:false});
        save();
        renderTasks();
        refreshDashboard();
      });
    }

    // -------------------- Invitation --------------------
    const HEADER_DATAURI = 'data:image/png;base64,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';

    function normalizeEndDate(){
      if(!plan.event.endDate) plan.event.endDate = plan.event.startDate;
    }

    function getDateRangeText(){
      const sD = plan.event.startDate;
      const eD = plan.event.endDate || plan.event.startDate;
      const sT = plan.event.startTime;
      const eT = plan.event.endTime;

      if(!sD) return '';
      if(eD && eD !== sD){
        return `${fmtDateLong(sD)}, ${sT||'--:--'} Uhr bis ${fmtDateLong(eD)}, ${eT||'--:--'} Uhr`;
      }
      // same day
      if(sT || eT) return `${fmtDateLong(sD)}, ${sT||'--:--'} – ${eT||'--:--'} Uhr`;
      return fmtDateLong(sD);
    }

    function getQrUrl(){
      const link = (plan.event.forms||'').trim();
      if(!link) return '';
      const enc = encodeURIComponent(link);
      return `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${enc}`;
    }

    function listFromBring(text){
      const lines = (text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      // keep bullets
      return lines.map(l=>l.replace(/^[-*•]\s*/,'• '));
    }

    function buildInvitationHtml(){
      normalizeEndDate();
      const ev = plan.event;
      const title = ev.title || 'Ausflug';
      const range = getDateRangeText();
      const cost = Number(ev.cost||0);
      const bring = listFromBring(ev.bring);
      const forms = (ev.forms||'').trim();
      const qr = getQrUrl();

      const kv = [
        ['Wann?', range],
        ['Wo?', ev.place],
        ['Treffpunkt', ev.meeting],
        ['Für wen?', ev.target],
        ['Kosten', cost ? `${cost.toFixed(cost%1?1:0)} € pro Kind` : '' ],
        ['Anmeldeschluss', ev.deadline ? fmtDateLong(ev.deadline) : '' ],
      ].filter(r=>String(r[1]||'').trim().length);

      const bringHtml = bring.length ? `<ul style="margin:6px 0 0 18px; padding:0;">${bring.map(x=>`<li>${escapeHtml(x.replace(/^•\s*/,''))}</li>`).join('')}</ul>` : '<div class="tiny">(keine Angaben)</div>';

      const programHtml = (ev.program||'').trim() ? `<div class="invite-section-title">Was steht auf dem Programm?</div><div>${escapeHtml(ev.program).replaceAll('\n','<br>')}</div>` : '';
      const notesHtml = (ev.notes||'').trim() ? `<div class="invite-section-title">Hinweise</div><div>${escapeHtml(ev.notes).replaceAll('\n','<br>')}</div>` : '';

      const formsLine = forms ? `<div style="margin-top:6px;">Anmeldung per QR-Code oder Link: <a href="${escapeHtml(forms)}">${escapeHtml(forms)}</a></div>` : '';

      const contactLine = (ev.contact||'').trim() ? `<div style="margin-top:6px;">Kontakt: ${escapeHtml(ev.contact)}</div>` : '';

      const footerSmall = `Mit der Anmeldung wird dem Verein gestattet, Bilder von Kindern bei Jugendaktionen auf der Homepage und in der örtlichen Presse zu veröffentlichen. Ein Widerspruch ist jederzeit schriftlich möglich.`;

      return `
        <div id="invitePreview" aria-label="Einladungsvorschau">
          <div class="invite-header"><img alt="JSC Header" src="${HEADER_DATAURI}"></div>
          <div style="margin:6px 0;">Liebe Eltern,</div>
          <div>wir planen eine coole Aktion – hier sind alle Infos:</div>
          <div class="invite-title">${escapeHtml(title)}</div>

          <table class="invite-kv">
            ${kv.map(([k,v])=>`<tr><td class="k">${escapeHtml(k)}</td><td>${escapeHtml(v||'')}</td></tr>`).join('')}
          </table>

          <div class="invite-section-title">Was brauchst du?</div>
          ${bringHtml}

          ${programHtml}
          ${notesHtml}

          <div style="margin-top:12px;">Bitte melde dich rechtzeitig an.</div>
          ${formsLine}
          ${contactLine}

          <div style="margin-top:14px;">Wir freuen uns auf dich!</div>
          <div><b>Dein Jugendvorstand</b></div>

          <div class="invite-footer">
            <div class="tiny">${escapeHtml(footerSmall)}</div>
            <div class="qrbox">
              ${qr ? `<img alt="QR" src="${qr}">` : `<div class="tiny">(Kein Forms-Link → kein QR-Code)</div>`}
            </div>
          </div>
        </div>
      `;
    }

    function refreshInvitation(){
      $('#inviteHost').innerHTML = buildInvitationHtml();
      setStatus('Einladung aktualisiert');
    }

    $('#refreshInvite').addEventListener('click', refreshInvitation);
    $('#printInvite').addEventListener('click', printInvitation);

    function printInvitation(){
      // Open a clean print window with all necessary CSS
      const html = buildInvitationHtml();
      const w = window.open('', '_blank', 'width=900,height=900');
      if(!w){ alert('Popup wurde blockiert. Bitte Popups erlauben.'); return; }

      const printCss = `
        <style>
          @page { size: A4; margin: 14mm; }
          body{ font-family:${JSON.stringify(getComputedStyle(document.body).fontFamily)}; color:#000; }
          a{ color:#0000ee; }
          #invitePreview{ max-width: none; border:none; }
          .invite-footer{ grid-template-columns: 1fr 220px; }
          .qrbox{ border:1px solid #000; }
        </style>
      `;

      w.document.open();
      w.document.write(`<!doctype html><html><head><meta charset="utf-8">${printCss}</head><body>${html}</body></html>`);
      w.document.close();

      // Wait for images then print
      const imgs = Array.from(w.document.images);
      let pending = imgs.length;
      const done = ()=>{ try{ w.focus(); w.print(); }catch(e){ console.error(e); } };
      if(pending===0) return done();
      imgs.forEach(img=>{
        if(img.complete){ pending--; if(pending===0) done(); return; }
        img.onload = ()=>{ pending--; if(pending===0) done(); };
        img.onerror = ()=>{ pending--; if(pending===0) done(); };
      });
    }

    function downloadInvitationHtml(){
      const content = buildInvitationHtml();
      const blob = new Blob([`<!doctype html><html><head><meta charset="utf-8"><title>Einladung</title></head><body>${content}</body></html>`], {type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (plan.event.title || 'Einladung').replace(/[^a-z0-9_-]+/gi,'_') + '.html';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // -------------------- ICS --------------------
    $('#downloadIcs').addEventListener('click', ()=>{
      const ev = plan.event;
      if(!ev.startDate){ alert('Bitte Startdatum eintragen.'); return; }
      const start = toLocalISO(ev.startDate, ev.startTime || '00:00');
      const endDate = ev.endDate || ev.startDate;
      const end = toLocalISO(endDate, ev.endTime || (ev.startTime||'00:00'));

      function pad(n){return String(n).padStart(2,'0');}
      function toIcs(dt){
        // convert to UTC basic format
        const u = new Date(dt.getTime() - dt.getTimezoneOffset()*60000);
        return `${u.getUTCFullYear()}${pad(u.getUTCMonth()+1)}${pad(u.getUTCDate())}T${pad(u.getUTCHours())}${pad(u.getUTCMinutes())}00Z`;
      }

      const uid = `jsc-${Date.now()}@jsckn`;
      const lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//JSC-Ausflugs-Planer//DE',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        'BEGIN:VEVENT',
        `UID:${uid}`,
        `DTSTAMP:${toIcs(new Date())}`,
        `DTSTART:${toIcs(start)}`,
        `DTEND:${toIcs(end)}`,
        `SUMMARY:${(ev.title||'JSC Ausflug').replace(/\n/g,' ')}`,
        ev.place ? `LOCATION:${(ev.place).replace(/\n/g,' ')}` : '',
        'END:VEVENT',
        'END:VCALENDAR'
      ].filter(Boolean).join('\r\n');

      const blob = new Blob([lines], {type:'text/calendar'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (ev.title || 'JSC-Ausflug').replace(/[^a-z0-9_-]+/gi,'_') + '.ics';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // -------------------- Dashboard --------------------
    function refreshDashboard(){
      const ev = plan.event;
      const kids = plan.people.children.length;
      const carers = plan.people.carers.length;
      const cars = plan.cars.length;
      const seats = plan.cars.reduce((a,c)=>a+Number(c.seats||0),0);
      const tasksDone = plan.tasks.filter(t=>t.done).length;
      const tasksAll = plan.tasks.length;

      const range = getDateRangeText();
      $('#dashSummary').innerHTML = `
        <div><b>Event:</b> ${escapeHtml(ev.title || '(kein Titel)')}</div>
        <div><b>Zeitraum:</b> ${escapeHtml(range || '(kein Datum)')}</div>
        <div><b>Ort:</b> ${escapeHtml(ev.place || '(kein Ort)')}</div>
        <div style="margin-top:8px;"><b>Teilnehmer:</b> ${kids} Kinder, ${carers} Betreuer</div>
        <div><b>Autos:</b> ${cars} – Sitze gesamt: ${seats}</div>
        <div style="margin-top:8px;"><b>Checkliste:</b> ${tasksDone}/${tasksAll} erledigt</div>
      `;
    }

    // -------------------- Import/Export & persistence --------------------
    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(plan));
      setStatus('Gespeichert');
    }

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      try{
        const obj = JSON.parse(raw);
        plan = obj;
      }catch(e){
        console.warn('Load failed', e);
      }
    }

    function exportJson(){
      const blob = new Blob([JSON.stringify(plan,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'JSC-Ausflugs-Plan.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJsonFile(file){
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const obj = JSON.parse(fr.result);
          plan = obj;
          save();
          renderAll();
          refreshInvitation();
          refreshDashboard();
          alert('Import erfolgreich.');
        }catch(e){
          alert('Import fehlgeschlagen: ' + e.message);
        }
      };
      fr.readAsText(file);
    }

    $('#fileInput').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if(f) importJsonFile(f);
      e.target.value='';
    });

    $('#exportJsonBtn').addEventListener('click', exportJson);
    $('#importJsonBtn').addEventListener('click', ()=>$('#fileInput').click());
    $('#saveBtn').addEventListener('click', ()=>{ save(); alert('Gespeichert.'); });
    $('#resetBtn').addEventListener('click', ()=>{
      if(confirm('Wirklich Reset?')){ plan = defaultPlan(); save(); renderAll(); refreshInvitation(); refreshDashboard(); }
    });

    function loadExample(){
      plan = defaultPlan();
      plan.event.title = 'Sport & Spiele Wochenende';
      plan.event.startDate = '2026-04-17';
      plan.event.startTime = '13:00';
      plan.event.endDate = '2026-04-17';
      plan.event.endTime = '14:00';
      plan.event.place = 'Stadion';
      plan.event.meeting = 'Altenbürgzentrum';
      plan.event.target = 'alle ab 8 Jahren';
      plan.event.cost = 5;
      plan.event.deadline = '2026-04-08';
      plan.event.forms = 'https://forms.gle/VnAoZpbchnaiMK2u9';
      plan.event.contact = 'jugendvorstand-jsc@web.de';
      plan.event.bring = '• Trinkflasche\n• Wetterfeste Kleidung\n• Sonnencreme\n• eigenes Zelt';
      plan.event.program = 'Nachdem wir unsere Zelte aufgebaut haben, werden spannende Matches ausgetragen. Darunter Fußball, Volleyball, Brennball und so weiter.';
      plan.event.notes = 'Kuchen- und Salatspenden bereichern unser Buffet am Abend.';
      plan.people.children = [{name:'Max', age:'10'},{name:'Lena', age:'12'}];
      plan.people.carers = [{name:'Anna', phone:'0151...', driver:true},{name:'Tom', phone:'0176...', driver:false}];
      plan.cars = [{driver:'Anna', label:'Kombi', seats:5}];
      save();
      renderAll();
      refreshInvitation();
      refreshDashboard();
      alert('Beispieldaten geladen.');
    }

    // -------------------- Render all --------------------
    function renderAll(){
      // fields
      for(const [id, path] of bindings){
        const el = $('#'+id);
        if(!el) continue;
        const v = getByPath(plan, path);
        el.value = (id==='evCost') ? String(v ?? 0) : (v ?? '');
      }
      renderChildren();
      renderCarers();
      renderCars();
      renderTasks();
    }

    // -------------------- Status --------------------
    let statusTimer=null;
    function setStatus(text){
      $('#statusLeft').textContent = text;
      if(statusTimer) clearTimeout(statusTimer);
      statusTimer = setTimeout(()=>{ $('#statusLeft').textContent = 'Bereit'; }, 1200);
    }

    // -------------------- Init --------------------
    wireBindings();
    bindPeopleEvents();
    bindCarEvents();
    bindTaskEvents();

    load();
    // Ensure defaults if missing
    plan.event = Object.assign(defaultPlan().event, plan.event||{});
    plan.people = Object.assign(defaultPlan().people, plan.people||{});
    plan.people.children = plan.people.children || [];
    plan.people.carers = plan.people.carers || [];
    plan.cars = plan.cars || [];
    plan.tasks = plan.tasks || defaultPlan().tasks;

    requireLogin();

  </script>
</body>
</html>
